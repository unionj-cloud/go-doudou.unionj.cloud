import{r as e,o as r,a as c,b as s,e as a,w as D,F as t,g as n,f as p}from"./app.04f9bf74.js";import{_ as i,a as y,b,c as d}from"./grafana.274edcdc.js";import{_ as u}from"./plugin-vue_export-helper.21dcd24c.js";const C={},m=s("h1",{id:"restful",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#restful","aria-hidden":"true"},"#"),n(" RESTful")],-1),h=s("h2",{id:"\u670D\u52A1\u6CE8\u518C\u4E0E\u53D1\u73B0",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#\u670D\u52A1\u6CE8\u518C\u4E0E\u53D1\u73B0","aria-hidden":"true"},"#"),n(" \u670D\u52A1\u6CE8\u518C\u4E0E\u53D1\u73B0")],-1),A=s("p",null,[n("Go-doudou\u652F\u6301\u4E24\u79CD\u670D\u52A1\u6CE8\u518C\u4E0E\u53D1\u73B0\u673A\u5236\uFF1A"),s("code",null,"memberlist"),n("\u548C"),s("code",null,"nacos")],-1),E=s("code",null,"memberlist",-1),g=n(": \u57FA\u4E8E"),v={href:"https://www.cs.cornell.edu/projects/Quicksilver/public_pdfs/SWIM.pdf",target:"_blank",rel:"noopener noreferrer"},f=n("SWIM gossip protocol"),_=n("\uFF0C\u53BB\u4E2D\u5FC3\u5316\uFF0C\u70B9\u5BF9\u70B9\u67B6\u6784\uFF0C\u65E0\u987Bleader\u9009\u4E3E\uFF0C\u4ECE"),k={href:"https://github.com/hashicorp/memberlist",target:"_blank",rel:"noopener noreferrer"},w=n("hashicorp/memberlist"),x=n("\u5E93fork\u51FA\u6765\u5E76\u505A\u4E86\u4E00\u4E9B\u4FEE\u6539"),R={href:"https://github.com/alibaba/nacos",target:"_blank",rel:"noopener noreferrer"},F=s("code",null,"nacos",-1),S=n(": \u4E2D\u5FC3\u5316\u7684\uFF0Cleader-follower\u67B6\u6784\uFF0C\u51FA\u81EA\u963F\u91CC\u5DF4\u5DF4"),q=p(`<div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p><code>memberlist</code>\u548C<code>nacos</code>\u4E24\u79CD\u673A\u5236\u53EF\u4EE5\u5728\u4E00\u4E2A\u670D\u52A1\u4E2D\u540C\u65F6\u4F7F\u7528</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">GDD_SERVICE_DISCOVERY_MODE=memberlist,nacos</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></div><h3 id="memberlist" tabindex="-1"><a class="header-anchor" href="#memberlist" aria-hidden="true">#</a> Memberlist</h3><p>\u9996\u5148\uFF0C\u7ED9<code>main</code>\u51FD\u6570\u52A0\u5165\u5982\u4E0B\u4EE3\u7801</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    logrus.</span><span style="color:#DCDCAA;">Panic</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u5176\u6B21\uFF0C\u914D\u7F6E\u5982\u4E0B\u73AF\u5883\u53D8\u91CF</p><ul><li><code>GDD_MEM_SEED</code>: \u79CD\u5B50\u8282\u70B9\u8FDE\u63A5\u5730\u5740\uFF0C\u591A\u4E2A\u5730\u5740\u7528\u82F1\u6587\u9017\u53F7\u9694\u5F00</li><li><code>GDD_MEM_PORT</code>: \u76D1\u542C\u7AEF\u53E3\uFF0C\u9ED8\u8BA4\u76D1\u542C<code>7946</code>\u7AEF\u53E3</li><li><code>GDD_MEM_HOST</code>: \u5BF9\u5916\u53D1\u5E03\u7684\u8FDE\u63A5\u5730\u5740\uFF0C\u9ED8\u8BA4\u662F\u79C1\u6709IP</li><li><code>GDD_SERVICE_DISCOVERY_MODE</code>: \u53EF\u4EE5\u4E0D\u7528\u914D\u7F6E\uFF0C\u9ED8\u8BA4\u503C\u5C31\u662F<code>memberlist</code></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">GDD_MEM_SEED=localhost:7946  </span><span style="color:#6A9955;"># Required</span></span>
<span class="line"><span style="color:#D4D4D4;">GDD_MEM_PORT=56199 </span><span style="color:#6A9955;"># Optional</span></span>
<span class="line"><span style="color:#D4D4D4;">GDD_MEM_HOST=localhost </span><span style="color:#6A9955;"># Optional</span></span>
<span class="line"><span style="color:#D4D4D4;">GDD_SERVICE_DISCOVERY_MODE=memberlist </span><span style="color:#6A9955;"># Optional</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="nacos" tabindex="-1"><a class="header-anchor" href="#nacos" aria-hidden="true">#</a> Nacos</h3><p>Go-doudou\u5185\u5EFA\u652F\u6301\u4F7F\u7528\u963F\u91CC\u5F00\u53D1\u7684Nacos\u4F5C\u4E3A\u6CE8\u518C\u4E2D\u5FC3\uFF0C\u5B9E\u73B0\u670D\u52A1\u6CE8\u518C\u4E0E\u53D1\u73B0\u3002</p><p>\u9996\u5148\uFF0C\u7ED9<code>main</code>\u51FD\u6570\u52A0\u5165\u5982\u4E0B\u4EE3\u7801</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    logrus.</span><span style="color:#DCDCAA;">Panic</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u6CA1\u9519\uFF0C\u8DDF<code>memberlist</code>\u673A\u5236\u6240\u9700\u6DFB\u52A0\u7684\u4EE3\u7801\u5B8C\u5168\u76F8\u540C\u3002</p><p>\u5176\u6B21\uFF0C\u914D\u7F6E\u5982\u4E0B\u73AF\u5883\u53D8\u91CF</p><ul><li><code>GDD_NACOS_SERVER_ADDR</code>: Nacos\u670D\u52A1\u7AEF\u5730\u5740</li><li><code>GDD_SERVICE_DISCOVERY_MODE</code>: \u670D\u52A1\u53D1\u73B0\u673A\u5236\u540D\u79F0</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">GDD_NACOS_SERVER_ADDR=http://localhost:8848/nacos </span><span style="color:#6A9955;"># Required</span></span>
<span class="line"><span style="color:#D4D4D4;">GDD_SERVICE_DISCOVERY_MODE=nacos </span><span style="color:#6A9955;"># Required</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="\u5BA2\u6237\u7AEF\u8D1F\u8F7D\u5747\u8861" tabindex="-1"><a class="header-anchor" href="#\u5BA2\u6237\u7AEF\u8D1F\u8F7D\u5747\u8861" aria-hidden="true">#</a> \u5BA2\u6237\u7AEF\u8D1F\u8F7D\u5747\u8861</h2><h3 id="\u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-memberlist\u7528" tabindex="-1"><a class="header-anchor" href="#\u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-memberlist\u7528" aria-hidden="true">#</a> \u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861 (memberlist\u7528)</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> *segclient.WordcloudSegClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_MODE&quot;</span><span style="color:#D4D4D4;">) == </span><span style="color:#CE9178;">&quot;micro&quot;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			logrus.</span><span style="color:#DCDCAA;">Panicln</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">provider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-segsvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(provider))</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">segClientProxy</span><span style="color:#D4D4D4;"> := segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClientProxy</span><span style="color:#D4D4D4;">(segClient)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudMaker</span><span style="color:#D4D4D4;">(conf, segClientProxy, minioClient, browser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="\u5E73\u6ED1\u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-memberlist\u7528" tabindex="-1"><a class="header-anchor" href="#\u5E73\u6ED1\u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-memberlist\u7528" aria-hidden="true">#</a> \u5E73\u6ED1\u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861 (memberlist\u7528)</h3><p>\u5982\u679C\u73AF\u5883\u53D8\u91CF<code>GDD_WEIGHT</code>\u548C<code>GDD_MEM_WEIGHT</code>\u90FD\u6CA1\u6709\u8BBE\u7F6E\uFF0C\u9ED8\u8BA4\u6743\u91CD\u662F1\u3002\u5982\u679C\u8BBE\u7F6E\u6743\u91CD\u4E3A0\uFF0C \u4E14<code>GDD_MEM_WEIGHT_INTERVAL</code>\u73AF\u5883\u53D8\u91CF\u5927\u4E8E<code>0s</code>\uFF0C\u5219\u5F00\u542F\u6743\u91CD\u81EA\u9002\u5E94\u8BA1\u7B97\u529F\u80FD\uFF0C\u5373\u6BCF\u9694<code>GDD_MEM_WEIGHT_INTERVAL</code>\u8BBE\u7F6E\u7684\u95F4\u9694\u65F6\u95F4\u6839\u636E\u8282\u70B9\u7684\u5065\u5EB7\u503C\u548CCPU\u7A7A\u95F2\u6BD4\u4F8B\u8BA1\u7B97\u6743\u91CD\uFF0C\u5E76\u53D1\u9001\u7ED9\u5176\u4ED6\u8282\u70B9\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> *segclient.WordcloudSegClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_MODE&quot;</span><span style="color:#D4D4D4;">) == </span><span style="color:#CE9178;">&quot;micro&quot;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			logrus.</span><span style="color:#DCDCAA;">Panicln</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">provider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewSmoothWeightedRoundRobinProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-segsvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(provider))</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">segClientProxy</span><span style="color:#D4D4D4;"> := segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClientProxy</span><span style="color:#D4D4D4;">(segClient)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudMaker</span><span style="color:#D4D4D4;">(conf, segClientProxy, minioClient, browser)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="\u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-nacos\u7528" tabindex="-1"><a class="header-anchor" href="#\u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-nacos\u7528" aria-hidden="true">#</a> \u7B80\u5355\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861 (nacos\u7528)</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		logrus.</span><span style="color:#DCDCAA;">Panic</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewStatsvc</span><span style="color:#D4D4D4;">(conf,</span></span>
<span class="line"><span style="color:#D4D4D4;">		nacosservicej.</span><span style="color:#DCDCAA;">NewEcho</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">			ddhttp.</span><span style="color:#DCDCAA;">WithRootPath</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;/nacos-service-j&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">			ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">NewNacosRRServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;nacos-service-j&quot;</span><span style="color:#D4D4D4;">))),</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewStatsvcHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="\u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-nacos\u7528" tabindex="-1"><a class="header-anchor" href="#\u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861-nacos\u7528" aria-hidden="true">#</a> \u52A0\u6743\u8F6E\u8BE2\u8D1F\u8F7D\u5747\u8861 (nacos\u7528)</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		logrus.</span><span style="color:#DCDCAA;">Panic</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewStatsvc</span><span style="color:#D4D4D4;">(conf,</span></span>
<span class="line"><span style="color:#D4D4D4;">		nacosservicej.</span><span style="color:#DCDCAA;">NewEcho</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">			ddhttp.</span><span style="color:#DCDCAA;">WithRootPath</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;/nacos-service-j&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">			ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">NewNacosWRRServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;nacos-service-j&quot;</span><span style="color:#D4D4D4;">))),</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewStatsvcHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="\u9650\u6D41" tabindex="-1"><a class="header-anchor" href="#\u9650\u6D41" aria-hidden="true">#</a> \u9650\u6D41</h2><h3 id="\u7528\u6CD5" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5" aria-hidden="true">#</a> \u7528\u6CD5</h3>`,27),N=n("Go-doudou\u5185\u7F6E\u4E86\u57FA\u4E8E"),M={href:"https://pkg.go.dev/golang.org/x/time/rate",target:"_blank",rel:"noopener noreferrer"},G=n("golang.org/x/time/rate"),L=n("\u5B9E\u73B0\u7684\u4EE4\u724C\u6876\u7B97\u6CD5\u7684\u5185\u5B58\u9650\u6D41\u5668\u3002"),P=p("<p>\u5728<code>github.com/unionj-cloud/go-doudou/framework/ratelimit/memrate</code>\u5305\u91CC\u6709\u4E00\u4E2A<code>MemoryStore</code>\u7ED3\u6784\u4F53\uFF0C\u5B58\u50A8\u4E86key\u548C<code>Limiter</code>\u5B9E\u4F8B\u5BF9\u3002<code>Limiter</code>\u5B9E\u4F8B\u662F\u9650\u6D41\u5668\u5B9E\u4F8B\uFF0Ckey\u662F\u8BE5\u9650\u6D41\u5668\u5B9E\u4F8B\u7684\u952E\u3002</p><p>\u4F60\u53EF\u4EE5\u5F80<code>memrate.NewLimiter</code>\u5DE5\u5382\u51FD\u6570\u4F20\u5165\u4E00\u4E2A\u53EF\u9009\u51FD\u6570<code>memrate.WithTimer</code>\uFF0C\u8BBE\u7F6E\u5F53key\u7A7A\u95F2\u65F6\u95F4\u8D85\u8FC7<code>timeout</code>\u4EE5\u540E\u7684\u56DE\u8C03\u51FD\u6570\uFF0C\u6BD4\u5982\u53EF\u4EE5\u4ECE<code>MemoryStore</code>\u5B9E\u4F8B\u91CC\u5C06\u8BE5key\u5220\u9664\uFF0C\u4EE5\u91CA\u653E\u5185\u5B58\u8D44\u6E90\u3002</p>",2),W=n("Go-doudou\u8FD8\u63D0\u4F9B\u4E86\u57FA\u4E8E "),O={href:"https://github.com/go-redis/redis_rate",target:"_blank",rel:"noopener noreferrer"},H=n("go-redis/redis_rate"),I=n(" \u5E93\u5C01\u88C5\u7684GCRA\u9650\u6D41\u7B97\u6CD5\u7684redis\u9650\u6D41\u5668\u3002\u8BE5\u9650\u6D41\u5668\u652F\u6301\u8DE8\u5B9E\u4F8B\u7684\u5168\u5C40\u9650\u6D41\u3002"),B=p(`<h3 id="\u5185\u5B58\u9650\u6D41\u5668\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u5185\u5B58\u9650\u6D41\u5668\u793A\u4F8B" aria-hidden="true">#</a> \u5185\u5B58\u9650\u6D41\u5668\u793A\u4F8B</h3><p>\u5185\u5B58\u9650\u6D41\u5668\u57FA\u4E8E\u672C\u673A\u5185\u5B58\uFF0C\u53EA\u652F\u6301\u672C\u673A\u9650\u6D41\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewUsersvcHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">store</span><span style="color:#D4D4D4;"> := memrate.</span><span style="color:#DCDCAA;">NewMemoryStore</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(_ context.Context, store *memrate.MemoryStore, key </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">) ratelimit.Limiter {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> memrate.</span><span style="color:#DCDCAA;">NewLimiter</span><span style="color:#D4D4D4;">(</span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">, </span><span style="color:#B5CEA8;">30</span><span style="color:#D4D4D4;">, memrate.</span><span style="color:#DCDCAA;">WithTimer</span><span style="color:#D4D4D4;">(</span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">*time.Second, </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">			store.</span><span style="color:#DCDCAA;">DeleteKey</span><span style="color:#D4D4D4;">(key)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}))</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>\u6CE8\u610F\uFF1A</strong> \u4F60\u9700\u8981\u81EA\u5DF1\u5B9E\u73B0http middleware\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// RateLimit limits rate based on memrate.MemoryStore</span></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">RateLimit</span><span style="color:#D4D4D4;">(store *memrate.MemoryStore) </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(inner http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(inner http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> http.</span><span style="color:#DCDCAA;">HandlerFunc</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(w http.ResponseWriter, r *http.Request) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> := r.RemoteAddr[:strings.</span><span style="color:#DCDCAA;">LastIndex</span><span style="color:#D4D4D4;">(r.RemoteAddr, </span><span style="color:#CE9178;">&quot;:&quot;</span><span style="color:#D4D4D4;">)]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">limiter</span><span style="color:#D4D4D4;"> := store.</span><span style="color:#DCDCAA;">GetLimiter</span><span style="color:#D4D4D4;">(key)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !limiter.</span><span style="color:#DCDCAA;">Allow</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">				http.</span><span style="color:#DCDCAA;">Error</span><span style="color:#D4D4D4;">(w, </span><span style="color:#CE9178;">&quot;too many requests&quot;</span><span style="color:#D4D4D4;">, http.StatusTooManyRequests)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			inner.</span><span style="color:#DCDCAA;">ServeHTTP</span><span style="color:#D4D4D4;">(w, r)</span></span>
<span class="line"><span style="color:#D4D4D4;">		})</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="redis\u9650\u6D41\u5668\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#redis\u9650\u6D41\u5668\u793A\u4F8B" aria-hidden="true">#</a> Redis\u9650\u6D41\u5668\u793A\u4F8B</h3><p>Redis\u9650\u6D41\u5668\u53EF\u4EE5\u7528\u4E8E\u9700\u8981\u591A\u4E2A\u5B9E\u4F8B\u540C\u65F6\u5BF9\u4E00\u4E2Akey\u9650\u6D41\u7684\u573A\u666F\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudBff</span><span style="color:#D4D4D4;">(conf, minioClient, makerClientProxy, taskClientProxy, userClientProxy)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewWordcloudBffHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Auth</span><span style="color:#D4D4D4;">(userClientProxy))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rdb</span><span style="color:#D4D4D4;"> := redis.</span><span style="color:#DCDCAA;">NewClient</span><span style="color:#D4D4D4;">(&amp;redis.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Addr: fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">:6379&quot;</span><span style="color:#D4D4D4;">, conf.RedisConf.Host),</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">fn</span><span style="color:#D4D4D4;"> := redisrate.</span><span style="color:#DCDCAA;">LimitFn</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(ctx context.Context) ratelimit.Limit {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> ratelimit.</span><span style="color:#DCDCAA;">PerSecondBurst</span><span style="color:#D4D4D4;">(conf.ConConf.RatelimitRate, conf.ConConf.RatelimitBurst)</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">RedisRateLimit</span><span style="color:#D4D4D4;">(rdb, fn))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>\u6CE8\u610F\uFF1A</strong> \u4F60\u9700\u8981\u81EA\u5DF1\u5B9E\u73B0http middleware\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// RedisRateLimit limits rate based on redisrate.GcraLimiter</span></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">RedisRateLimit</span><span style="color:#D4D4D4;">(rdb redisrate.Rediser, fn redisrate.LimitFn) </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(inner http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(inner http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> http.</span><span style="color:#DCDCAA;">HandlerFunc</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(w http.ResponseWriter, r *http.Request) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">userId</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">UserIdFromContext</span><span style="color:#D4D4D4;">(r.</span><span style="color:#DCDCAA;">Context</span><span style="color:#D4D4D4;">())</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">limiter</span><span style="color:#D4D4D4;"> := redisrate.</span><span style="color:#DCDCAA;">NewGcraLimiterLimitFn</span><span style="color:#D4D4D4;">(rdb, strconv.</span><span style="color:#DCDCAA;">Itoa</span><span style="color:#D4D4D4;">(userId), fn)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !limiter.</span><span style="color:#DCDCAA;">Allow</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">				http.</span><span style="color:#DCDCAA;">Error</span><span style="color:#D4D4D4;">(w, </span><span style="color:#CE9178;">&quot;too many requests&quot;</span><span style="color:#D4D4D4;">, http.StatusTooManyRequests)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			inner.</span><span style="color:#DCDCAA;">ServeHTTP</span><span style="color:#D4D4D4;">(w, r)</span></span>
<span class="line"><span style="color:#D4D4D4;">		})</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="\u9694\u4ED3" tabindex="-1"><a class="header-anchor" href="#\u9694\u4ED3" aria-hidden="true">#</a> \u9694\u4ED3</h2><h3 id="\u7528\u6CD5-1" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5-1" aria-hidden="true">#</a> \u7528\u6CD5</h3><p>Go-doudou\u5728<code>github.com/unionj-cloud/go-doudou/framework/http</code>\u5305\u4E2D\u5185\u7F6E\u4E86\u57FA\u4E8E <a href="github.com/slok/goresilience">github.com/slok/goresilience</a> \u5C01\u88C5\u7684\u5F00\u7BB1\u5373\u7528\u7684\u9694\u4ED3\u529F\u80FD\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">http.</span><span style="color:#DCDCAA;">BulkHead</span><span style="color:#D4D4D4;">(</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">, </span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">*time.Millisecond)</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>\u4E0A\u9762\u7684\u793A\u4F8B\u4EE3\u7801\u4E2D\uFF0C\u7B2C\u4E00\u4E2A\u53C2\u6570<code>3</code>\u8868\u793A\u7528\u4E8E\u5904\u7406http\u8BF7\u6C42\u7684goroutine\u6C60\u4E2D\u7684worker\u6570\u91CF\uFF0C\u7B2C\u4E8C\u4E2A\u53C2\u6570<code>10*time.Millisecond</code>\u8868\u793A\u4E00\u4E2Ahttp\u8BF7\u6C42\u8FDB\u6765\u4EE5\u540E\u7B49\u5F85\u88AB\u5904\u7406\u7684\u6700\u957F\u7B49\u5F85\u65F6\u95F4\uFF0C\u5982\u679C\u8D85\u65F6\uFF0C\u5373\u76F4\u63A5\u8FD4\u56DE<code>429</code>\u72B6\u6001\u7801\u3002</p><h3 id="\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B" aria-hidden="true">#</a> \u793A\u4F8B</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudBff</span><span style="color:#D4D4D4;">(conf, minioClient, makerClientProxy, taskClientProxy, userClientProxy)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewWordcloudBffHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Auth</span><span style="color:#D4D4D4;">(userClientProxy))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rdb</span><span style="color:#D4D4D4;"> := redis.</span><span style="color:#DCDCAA;">NewClient</span><span style="color:#D4D4D4;">(&amp;redis.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Addr: fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">:6379&quot;</span><span style="color:#D4D4D4;">, conf.RedisConf.Host),</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">fn</span><span style="color:#D4D4D4;"> := redisrate.</span><span style="color:#DCDCAA;">LimitFn</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(ctx context.Context) ratelimit.Limit {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> ratelimit.</span><span style="color:#DCDCAA;">PerSecondBurst</span><span style="color:#D4D4D4;">(conf.ConConf.RatelimitRate, conf.ConConf.RatelimitBurst)</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">BulkHead</span><span style="color:#D4D4D4;">(conf.ConConf.BulkheadWorkers, conf.ConConf.BulkheadMaxwaittime))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="\u7194\u65AD-\u8D85\u65F6-\u91CD\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u7194\u65AD-\u8D85\u65F6-\u91CD\u8BD5" aria-hidden="true">#</a> \u7194\u65AD / \u8D85\u65F6 / \u91CD\u8BD5</h2><h3 id="\u7528\u6CD5-2" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5-2" aria-hidden="true">#</a> \u7528\u6CD5</h3><p>Go-doudou\u5728\u751F\u6210\u7684\u5BA2\u6237\u7AEF\u4EE3\u7801\u91CC\u5185\u7F6E\u4E86\u57FA\u4E8E <a href="github.com/slok/goresilience">github.com/slok/goresilience</a> \u5C01\u88C5\u7684\u7194\u65AD/\u8D85\u65F6/\u91CD\u8BD5\u7B49\u5F39\u6027\u673A\u5236\u7684\u4EE3\u7801\u3002\u4F60\u53EA\u9700\u8981\u6267\u884C\u5982\u4E0B\u547D\u4EE4\uFF0C\u751F\u6210\u5BA2\u6237\u7AEF\u4EE3\u7801\u62FF\u6765\u7528\u5373\u53EF</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">go-doudou svc http --handler -c --doc</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>-c</code>\u53C2\u6570\u8868\u793A\u751F\u6210Go\u8BED\u8A00\u5BA2\u6237\u7AEF\u4EE3\u7801\u3002\u751F\u6210\u7684<code>client</code>\u5305\u7684\u76EE\u5F55\u7ED3\u6784\u5982\u4E0B</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 client.go</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 clientproxy.go</span></span>
<span class="line"><span style="color:#D4D4D4;">\u2514\u2500\u2500 iclient.go</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u751F\u6210\u7684\u4EE3\u7801\u91CC\u5DF2\u7ECF\u6709\u9ED8\u8BA4\u7684<code>goresilience.Runner</code>\u5B9E\u4F8B\uFF0C\u4F60\u4E5F\u53EF\u4EE5\u901A\u8FC7<code>WithRunner(your_own_runner goresilience.Runner)</code>\u51FD\u6570\u4F20\u5165\u81EA\u5B9A\u4E49\u7684\u5B9E\u73B0\u3002</p><h3 id="\u793A\u4F8B-1" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-1" aria-hidden="true">#</a> \u793A\u4F8B</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> *segclient.WordcloudSegClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_MODE&quot;</span><span style="color:#D4D4D4;">) == </span><span style="color:#CE9178;">&quot;micro&quot;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			logrus.</span><span style="color:#DCDCAA;">Panicln</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">provider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewSmoothWeightedRoundRobinProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-segsvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(provider))</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">segClient</span><span style="color:#D4D4D4;"> = segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">segClientProxy</span><span style="color:#D4D4D4;"> := segclient.</span><span style="color:#DCDCAA;">NewWordcloudSegClientProxy</span><span style="color:#D4D4D4;">(segClient)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	... </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudMaker</span><span style="color:#D4D4D4;">(conf, segClientProxy, minioClient, browser)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#\u65E5\u5FD7" aria-hidden="true">#</a> \u65E5\u5FD7</h2><h3 id="\u7528\u6CD5-3" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5-3" aria-hidden="true">#</a> \u7528\u6CD5</h3><p>Go-doudou\u5728<code>github.com/unionj-cloud/go-doudou/framework/logger</code>\u5305\u91CC\u5185\u7F6E\u4E86\u4E00\u4E2A\u5168\u5C40\u7684<code>logrus.Entry</code>\u3002\u5982\u679C<code>GDD_ENV</code>\u73AF\u5883\u53D8\u91CF\u4E0D\u7B49\u4E8E\u7A7A\u5B57\u7B26\u4E32\u548C<code>dev</code>\uFF0C\u5219\u4F1A\u5E26\u4E0A\u4E00\u4E9B\u5173\u4E8E\u670D\u52A1\u672C\u8EAB\u7684\u5143\u6570\u636E\u3002</p><p><code>logger</code>\u5305\u63D0\u4F9B\u4E00\u4E9B\u5305\u7EA7\u7684\u51FD\u6570\uFF0C\u53EF\u4EE5\u76F4\u63A5\u66FF\u6362\u5982<code>logrus.Info()</code>\u8FD9\u6837\u7684\u4EE3\u7801\u4E3A<code>logger.Info()</code>\u3002\u4F60\u4E5F\u53EF\u4EE5\u8C03\u7528<code>Init</code>\u51FD\u6570\u81EA\u5B9A\u4E49<code>logrus.Logger</code>\u5B9E\u4F8B\u3002</p><p>\u4F60\u8FD8\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E<code>GDD_LOG_LEVEL</code>\u73AF\u5883\u53D8\u91CF\u6765\u8BBE\u7F6E\u65E5\u5FD7\u7EA7\u522B\uFF0C\u914D\u7F6E<code>GDD_LOG_FORMAT</code>\u73AF\u5883\u53D8\u91CF\u6765\u8BBE\u7F6E\u65E5\u5FD7\u683C\u5F0F\u662F<code>json</code>\u8FD8\u662F<code>text</code>\u3002</p><p>There are two built-in log related middlewares for you, <code>ddhttp.Metrics</code> and <code>ddhttp.Logger</code>. In short, <code>ddhttp.Metrics</code> is for printing brief log with limited information, while <code>ddhttp.Logger</code> is for printing detail log with request and response body, headers, opentracing span and some other information, and it only takes effect when environment variable <code>GDD_LOG_LEVEL</code> is set to <code>debug</code>.</p><p>\u4F60\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E<code>GDD_LOG_REQ_ENABLE=true</code>\u6765\u5F00\u542Fhttp\u8BF7\u6C42\u548C\u54CD\u5E94\u7684\u65E5\u5FD7\u6253\u5370\uFF0C\u9ED8\u8BA4\u662F<code>false</code>\uFF0C\u5373\u4E0D\u6253\u5370\u3002</p><h3 id="\u793A\u4F8B-2" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-2" aria-hidden="true">#</a> \u793A\u4F8B</h3><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// \u4F60\u53EF\u4EE5\u7528lumberjack\u8FD9\u4E2A\u5E93\u7ED9\u670D\u52A1\u589E\u52A0\u65E5\u5FD7rotate\u7684\u529F\u80FD</span></span>
<span class="line"><span style="color:#D4D4D4;">logger.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">(logger.</span><span style="color:#DCDCAA;">WithWritter</span><span style="color:#D4D4D4;">(io.</span><span style="color:#DCDCAA;">MultiWriter</span><span style="color:#D4D4D4;">(os.Stdout, &amp;lumberjack.Logger{</span></span>
<span class="line"><span style="color:#D4D4D4;">    Filename:   filepath.</span><span style="color:#DCDCAA;">Join</span><span style="color:#D4D4D4;">(os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;LOG_PATH&quot;</span><span style="color:#D4D4D4;">), fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">.log&quot;</span><span style="color:#D4D4D4;">, ddconfig.GddServiceName.</span><span style="color:#DCDCAA;">Load</span><span style="color:#D4D4D4;">())),</span></span>
<span class="line"><span style="color:#D4D4D4;">    MaxSize:    </span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">,  </span><span style="color:#6A9955;">// \u5355\u4EFD\u65E5\u5FD7\u6587\u4EF6\u6700\u59275M\uFF0C\u8D85\u8FC7\u5C31\u4F1A\u521B\u5EFA\u65B0\u7684\u65E5\u5FD7\u6587\u4EF6</span></span>
<span class="line"><span style="color:#D4D4D4;">    MaxBackups: </span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">, </span><span style="color:#6A9955;">// \u6700\u591A\u4FDD\u755910\u4EFD\u65E5\u5FD7\u6587\u4EF6</span></span>
<span class="line"><span style="color:#D4D4D4;">    MaxAge:     </span><span style="color:#B5CEA8;">7</span><span style="color:#D4D4D4;">,  </span><span style="color:#6A9955;">// \u65E5\u5FD7\u6587\u4EF6\u6700\u957F\u4FDD\u75597\u5929</span></span>
<span class="line"><span style="color:#D4D4D4;">    Compress:   </span><span style="color:#569CD6;">true</span><span style="color:#D4D4D4;">, </span><span style="color:#6A9955;">// \u662F\u5426\u5F00\u542F\u65E5\u5FD7\u538B\u7F29</span></span>
<span class="line"><span style="color:#D4D4D4;">})))</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="elk\u6280\u672F\u6808" tabindex="-1"><a class="header-anchor" href="#elk\u6280\u672F\u6808" aria-hidden="true">#</a> ELK\u6280\u672F\u6808</h3><p><code>logger</code>\u5305\u652F\u6301\u96C6\u6210ELK\u6280\u672F\u6808\u3002</p><h4 id="\u793A\u4F8B-3" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-3" aria-hidden="true">#</a> \u793A\u4F8B</h4><div class="language-yaml ext-yml line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">version</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&#39;3.9&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">services</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">elasticsearch</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">container_name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">elasticsearch</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">image</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&quot;docker.elastic.co/elasticsearch/elasticsearch:7.2.0&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">environment</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">&quot;ES_JAVA_OPTS=-Xms1g -Xmx1g&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">&quot;discovery.type=single-node&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">ports</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">&quot;9200:9200&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">volumes</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">./esdata:/usr/share/elasticsearch/data</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;">ipv4_address</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">172.28.1.9</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">kibana</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">container_name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">kibana</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">image</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&quot;docker.elastic.co/kibana/kibana:7.2.0&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">ports</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">&quot;5601:5601&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;">ipv4_address</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">172.28.1.10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">filebeat</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">container_name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">filebeat</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">image</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&quot;docker.elastic.co/beats/filebeat:7.2.0&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">volumes</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro</span></span>
<span class="line"><span style="color:#D4D4D4;">     - </span><span style="color:#CE9178;">./log:/var/log</span></span>
<span class="line"><span style="color:#D4D4D4;">   </span><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">     </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">       </span><span style="color:#569CD6;">ipv4_address</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">172.28.1.11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">ipam</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">driver</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">default</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">config</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        - </span><span style="color:#569CD6;">subnet</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">172.28.0.0/16</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="\u622A\u56FE" tabindex="-1"><a class="header-anchor" href="#\u622A\u56FE" aria-hidden="true">#</a> \u622A\u56FE</h4><p><img src="`+i+`" alt="elk"></p><h2 id="jaeger\u8C03\u7528\u94FE\u76D1\u63A7" tabindex="-1"><a class="header-anchor" href="#jaeger\u8C03\u7528\u94FE\u76D1\u63A7" aria-hidden="true">#</a> Jaeger\u8C03\u7528\u94FE\u76D1\u63A7</h2><h3 id="\u7528\u6CD5-4" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5-4" aria-hidden="true">#</a> \u7528\u6CD5</h3><p>\u96C6\u6210Jaeger\u8C03\u7528\u94FE\u76D1\u63A7\uFF0C\u53EA\u9700\u4E09\u6B65</p><ol><li>\u542F\u52A8Jaeger</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">docker run -d --name jaeger \\</span></span>
<span class="line"><span style="color:#D4D4D4;">  -p 6831:6831/udp \\</span></span>
<span class="line"><span style="color:#D4D4D4;">  -p 16686:16686 \\</span></span>
<span class="line"><span style="color:#D4D4D4;">  jaegertracing/all-in-one:1.29</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>\u7ED9<code>.env</code>\u6587\u4EF6\u6DFB\u52A0\u4E24\u884C\u914D\u7F6E</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">JAEGER_AGENT_HOST=localhost</span></span>
<span class="line"><span style="color:#D4D4D4;">JAEGER_AGENT_PORT=6831</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>\u5728<code>main</code>\u51FD\u6570\u91CC\u9760\u524D\u7684\u4F4D\u7F6E\u6DFB\u52A0\u4E09\u884C\u4EE3\u7801</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#9CDCFE;">tracer</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">closer</span><span style="color:#D4D4D4;"> := tracing.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> closer.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">opentracing.</span><span style="color:#DCDCAA;">SetGlobalTracer</span><span style="color:#D4D4D4;">(tracer)</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>\u7136\u540E\u4F60\u7684<code>main</code>\u51FD\u6570\u5E94\u8BE5\u662F\u7C7B\u4F3C\u8FD9\u4E2A\u6837\u5B50</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">tracer</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">closer</span><span style="color:#D4D4D4;"> := tracing.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> closer.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	opentracing.</span><span style="color:#DCDCAA;">SetGlobalTracer</span><span style="color:#D4D4D4;">(tracer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudMaker</span><span style="color:#D4D4D4;">(conf, segClientProxy, minioClient, browser)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewWordcloudMakerHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="\u622A\u56FE-1" tabindex="-1"><a class="header-anchor" href="#\u622A\u56FE-1" aria-hidden="true">#</a> \u622A\u56FE</h3><p><img src="`+y+'" alt="jaeger1"><img src="'+b+'" alt="jaeger2"></p><h2 id="grafana-prometheus" tabindex="-1"><a class="header-anchor" href="#grafana-prometheus" aria-hidden="true">#</a> Grafana / Prometheus</h2><h3 id="\u7528\u6CD5-5" tabindex="-1"><a class="header-anchor" href="#\u7528\u6CD5-5" aria-hidden="true">#</a> \u7528\u6CD5</h3>',56),T=n("\u8BF7\u53C2\u8003 "),V=n("prometheus\u670D\u52A1\u53D1\u73B0"),j=n(" \u7AE0\u8282\u548C\u4EE3\u7801\u5E93 "),U={href:"https://github.com/unionj-cloud/go-doudou-tutorials/tree/master/wordcloud",target:"_blank",rel:"noopener noreferrer"},J=n("wordcloud"),Y=p(`<h3 id="\u793A\u4F8B-4" tabindex="-1"><a class="header-anchor" href="#\u793A\u4F8B-4" aria-hidden="true">#</a> \u793A\u4F8B</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">version</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">&#39;3.9&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">services</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">prometheus</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">container_name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">prometheus</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">hostname</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">prometheus</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">image</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">wubin1989/go-doudou-prometheus-sd:v1.0.2</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">environment</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">GDD_SERVICE_NAME=prometheus</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">PROM_REFRESH_INTERVAL=15s</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">GDD_MEM_HOST=localhost</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">volumes</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">./prometheus/:/etc/prometheus/</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">ports</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">&quot;9090:9090&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">&quot;7946:7946&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">      - </span><span style="color:#CE9178;">&quot;7946:7946/udp&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">restart</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">always</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">healthcheck</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">test</span><span style="color:#D4D4D4;">: [ </span><span style="color:#CE9178;">&quot;CMD&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;curl&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;-f&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;http://localhost:9090&quot;</span><span style="color:#D4D4D4;"> ]</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">interval</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">10s</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">timeout</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">3s</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">retries</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">3</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#569CD6;">ipv4_address</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">172.28.1.1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">grafana</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">image</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">grafana/grafana:latest</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">container_name</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">grafana</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">volumes</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">		- </span><span style="color:#CE9178;">./grafana/provisioning:/etc/grafana/provisioning</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">environment</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">		- </span><span style="color:#CE9178;">GF_AUTH_DISABLE_LOGIN_FORM=false</span></span>
<span class="line"><span style="color:#D4D4D4;">		- </span><span style="color:#CE9178;">GF_AUTH_ANONYMOUS_ENABLED=false</span></span>
<span class="line"><span style="color:#D4D4D4;">		- </span><span style="color:#CE9178;">GF_AUTH_ANONYMOUS_ORG_ROLE=Admin</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">ports</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">		- </span><span style="color:#CE9178;">3000:3000</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#569CD6;">ipv4_address</span><span style="color:#D4D4D4;">: </span><span style="color:#B5CEA8;">172.28.1.8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">networks</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#569CD6;">testing_net</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#569CD6;">ipam</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">driver</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">default</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#569CD6;">config</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">        - </span><span style="color:#569CD6;">subnet</span><span style="color:#D4D4D4;">: </span><span style="color:#CE9178;">172.28.0.0/16</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="\u622A\u56FE-2" tabindex="-1"><a class="header-anchor" href="#\u622A\u56FE-2" aria-hidden="true">#</a> \u622A\u56FE</h3><p><img src="`+d+'" alt="grafana"></p>',4);function K(z,Q){const l=e("ExternalLinkIcon"),o=e("RouterLink");return r(),c(t,null,[m,h,A,s("ul",null,[s("li",null,[E,g,s("a",v,[f,a(l)]),_,s("a",k,[w,a(l)]),x]),s("li",null,[s("a",R,[F,a(l)]),S])]),q,s("p",null,[N,s("a",M,[G,a(l)]),L]),P,s("p",null,[W,s("a",O,[H,a(l)]),I]),B,s("p",null,[T,a(o,{to:"/zh/guide/deployment.html#prometheus%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"},{default:D(()=>[V]),_:1}),j,s("a",U,[J,a(l)])]),Y],64)}var ss=u(C,[["render",K]]);export{ss as default};
